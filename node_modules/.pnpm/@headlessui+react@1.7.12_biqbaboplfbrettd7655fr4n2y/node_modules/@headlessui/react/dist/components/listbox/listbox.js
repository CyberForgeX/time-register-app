import N,{Fragment as Te,createContext as Y,createRef as xe,useCallback as ye,useContext as Z,useEffect as ee,useMemo as h,useReducer as ge,useRef as D}from"react";import{useDisposables as j}from'../../hooks/use-disposables.js';import{useId as K}from'../../hooks/use-id.js';import{useIsoMorphicEffect as V}from'../../hooks/use-iso-morphic-effect.js';import{useComputed as te}from'../../hooks/use-computed.js';import{useSyncRefs as k}from'../../hooks/use-sync-refs.js';import{Features as oe,forwardRefWithAs as w,render as _,compact as Le}from'../../utils/render.js';import{match as C}from'../../utils/match.js';import{disposables as X}from'../../utils/disposables.js';import{Keys as y}from'../keyboard.js';import{Focus as R,calculateActiveIndex as Oe}from'../../utils/calculate-active-index.js';import{isDisabledReactIssue7711 as me}from'../../utils/bugs.js';import{isFocusableElement as Re,FocusableMode as ve,sortByDomNode as Se}from'../../utils/focus-management.js';import{useOpenClosed as Ae,State as W,OpenClosedProvider as Pe}from'../../internal/open-closed.js';import{useResolveButtonType as Ee}from'../../hooks/use-resolve-button-type.js';import{useOutsideClick as he}from'../../hooks/use-outside-click.js';import{Hidden as De,Features as Ce}from'../../internal/hidden.js';import{objectToFormEntries as Ie}from'../../utils/form.js';import{getOwnerDocument as Fe}from'../../utils/owner.js';import{useEvent as b}from'../../hooks/use-event.js';import{useControllable as Me}from'../../hooks/use-controllable.js';import{useLatestValue as ke}from'../../hooks/use-latest-value.js';import{useTrackedPointer as we}from'../../hooks/use-tracked-pointer.js';var _e=(o=>(o[o.Open=0]="Open",o[o.Closed=1]="Closed",o))(_e||{}),Ue=(o=>(o[o.Single=0]="Single",o[o.Multi=1]="Multi",o))(Ue||{}),Be=(o=>(o[o.Pointer=0]="Pointer",o[o.Other=1]="Other",o))(Be||{}),He=(i=>(i[i.OpenListbox=0]="OpenListbox",i[i.CloseListbox=1]="CloseListbox",i[i.GoToOption=2]="GoToOption",i[i.Search=3]="Search",i[i.ClearSearch=4]="ClearSearch",i[i.RegisterOption=5]="RegisterOption",i[i.UnregisterOption=6]="UnregisterOption",i[i.RegisterLabel=7]="RegisterLabel",i))(He||{});function $(e,r=o=>o){let o=e.activeOptionIndex!==null?e.options[e.activeOptionIndex]:null,n=Se(r(e.options.slice()),t=>t.dataRef.current.domRef.current),a=o?n.indexOf(o):null;return a===-1&&(a=null),{options:n,activeOptionIndex:a}}let Ge={[1](e){return e.dataRef.current.disabled||e.listboxState===1?e:{...e,activeOptionIndex:null,listboxState:1}},[0](e){if(e.dataRef.current.disabled||e.listboxState===0)return e;let r=e.activeOptionIndex,{isSelected:o}=e.dataRef.current,n=e.options.findIndex(a=>o(a.dataRef.current.value));return n!==-1&&(r=n),{...e,listboxState:0,activeOptionIndex:r}},[2](e,r){var a;if(e.dataRef.current.disabled||e.listboxState===1)return e;let o=$(e),n=Oe(r,{resolveItems:()=>o.options,resolveActiveIndex:()=>o.activeOptionIndex,resolveId:t=>t.id,resolveDisabled:t=>t.dataRef.current.disabled});return{...e,...o,searchQuery:"",activeOptionIndex:n,activationTrigger:(a=r.trigger)!=null?a:1}},[3]:(e,r)=>{if(e.dataRef.current.disabled||e.listboxState===1)return e;let n=e.searchQuery!==""?0:1,a=e.searchQuery+r.value.toLowerCase(),u=(e.activeOptionIndex!==null?e.options.slice(e.activeOptionIndex+n).concat(e.options.slice(0,e.activeOptionIndex+n)):e.options).find(i=>{var T;return!i.dataRef.current.disabled&&((T=i.dataRef.current.textValue)==null?void 0:T.startsWith(a))}),c=u?e.options.indexOf(u):-1;return c===-1||c===e.activeOptionIndex?{...e,searchQuery:a}:{...e,searchQuery:a,activeOptionIndex:c,activationTrigger:1}},[4](e){return e.dataRef.current.disabled||e.listboxState===1||e.searchQuery===""?e:{...e,searchQuery:""}},[5]:(e,r)=>{let o={id:r.id,dataRef:r.dataRef},n=$(e,a=>[...a,o]);return e.activeOptionIndex===null&&e.dataRef.current.isSelected(r.dataRef.current.value)&&(n.activeOptionIndex=n.options.indexOf(o)),{...e,...n}},[6]:(e,r)=>{let o=$(e,n=>{let a=n.findIndex(t=>t.id===r.id);return a!==-1&&n.splice(a,1),n});return{...e,...o,activationTrigger:1}},[7]:(e,r)=>({...e,labelId:r.id})},z=Y(null);z.displayName="ListboxActionsContext";function U(e){let r=Z(z);if(r===null){let o=new Error(`<${e} /> is missing a parent <Listbox /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(o,U),o}return r}let J=Y(null);J.displayName="ListboxDataContext";function B(e){let r=Z(J);if(r===null){let o=new Error(`<${e} /> is missing a parent <Listbox /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(o,B),o}return r}function Ne(e,r){return C(r.type,Ge,e,r)}let je=Te;function Ke(e,r){let{value:o,defaultValue:n,name:a,onChange:t,by:u=(s,f)=>s===f,disabled:c=!1,horizontal:i=!1,multiple:T=!1,...S}=e;const m=i?"horizontal":"vertical";let P=k(r),[g=T?[]:void 0,v]=Me(o,t,n),[A,p]=ge(Ne,{dataRef:xe(),listboxState:1,options:[],searchQuery:"",labelId:null,activeOptionIndex:null,activationTrigger:1}),l=D({static:!1,hold:!1}),x=D(null),E=D(null),Q=D(null),I=b(typeof u=="string"?(s,f)=>{let O=u;return(s==null?void 0:s[O])===(f==null?void 0:f[O])}:u),L=ye(s=>C(d.mode,{[1]:()=>g.some(f=>I(f,s)),[0]:()=>I(g,s)}),[g]),d=h(()=>({...A,value:g,disabled:c,mode:T?1:0,orientation:m,compare:I,isSelected:L,optionsPropsRef:l,labelRef:x,buttonRef:E,optionsRef:Q}),[g,c,T,A]);V(()=>{A.dataRef.current=d},[d]),he([d.buttonRef,d.optionsRef],(s,f)=>{var O;p({type:1}),Re(f,ve.Loose)||(s.preventDefault(),(O=d.buttonRef.current)==null||O.focus())},d.listboxState===0);let H=h(()=>({open:d.listboxState===0,disabled:c,value:g}),[d,c,g]),ne=b(s=>{let f=d.options.find(O=>O.id===s);f&&F(f.dataRef.current.value)}),ie=b(()=>{if(d.activeOptionIndex!==null){let{dataRef:s,id:f}=d.options[d.activeOptionIndex];F(s.current.value),p({type:2,focus:R.Specific,id:f})}}),re=b(()=>p({type:0})),ae=b(()=>p({type:1})),le=b((s,f,O)=>s===R.Specific?p({type:2,focus:R.Specific,id:f,trigger:O}):p({type:2,focus:s,trigger:O})),se=b((s,f)=>(p({type:5,id:s,dataRef:f}),()=>p({type:6,id:s}))),pe=b(s=>(p({type:7,id:s}),()=>p({type:7,id:null}))),F=b(s=>C(d.mode,{[0](){return v==null?void 0:v(s)},[1](){let f=d.value.slice(),O=f.findIndex(M=>I(M,s));return O===-1?f.push(s):f.splice(O,1),v==null?void 0:v(f)}})),ue=b(s=>p({type:3,value:s})),de=b(()=>p({type:4})),ce=h(()=>({onChange:F,registerOption:se,registerLabel:pe,goToOption:le,closeListbox:ae,openListbox:re,selectActiveOption:ie,selectOption:ne,search:ue,clearSearch:de}),[]),fe={ref:P},G=D(null),be=j();return ee(()=>{G.current&&n!==void 0&&be.addEventListener(G.current,"reset",()=>{F(n)})},[G,F]),N.createElement(z.Provider,{value:ce},N.createElement(J.Provider,{value:d},N.createElement(Pe,{value:C(d.listboxState,{[0]:W.Open,[1]:W.Closed})},a!=null&&g!=null&&Ie({[a]:g}).map(([s,f],O)=>N.createElement(De,{features:Ce.Hidden,ref:O===0?M=>{var q;G.current=(q=M==null?void 0:M.closest("form"))!=null?q:null}:void 0,...Le({key:s,as:"input",type:"hidden",hidden:!0,readOnly:!0,name:s,value:f})})),_({ourProps:fe,theirProps:S,slot:H,defaultTag:je,name:"Listbox"}))))}let Ve="button";function We(e,r){var A;let o=K(),{id:n=`headlessui-listbox-button-${o}`,...a}=e,t=B("Listbox.Button"),u=U("Listbox.Button"),c=k(t.buttonRef,r),i=j(),T=b(p=>{switch(p.key){case y.Space:case y.Enter:case y.ArrowDown:p.preventDefault(),u.openListbox(),i.nextFrame(()=>{t.value||u.goToOption(R.First)});break;case y.ArrowUp:p.preventDefault(),u.openListbox(),i.nextFrame(()=>{t.value||u.goToOption(R.Last)});break}}),S=b(p=>{switch(p.key){case y.Space:p.preventDefault();break}}),m=b(p=>{if(me(p.currentTarget))return p.preventDefault();t.listboxState===0?(u.closeListbox(),i.nextFrame(()=>{var l;return(l=t.buttonRef.current)==null?void 0:l.focus({preventScroll:!0})})):(p.preventDefault(),u.openListbox())}),P=te(()=>{if(t.labelId)return[t.labelId,n].join(" ")},[t.labelId,n]),g=h(()=>({open:t.listboxState===0,disabled:t.disabled,value:t.value}),[t]),v={ref:c,id:n,type:Ee(e,t.buttonRef),"aria-haspopup":"listbox","aria-controls":(A=t.optionsRef.current)==null?void 0:A.id,"aria-expanded":t.disabled?void 0:t.listboxState===0,"aria-labelledby":P,disabled:t.disabled,onKeyDown:T,onKeyUp:S,onClick:m};return _({ourProps:v,theirProps:a,slot:g,defaultTag:Ve,name:"Listbox.Button"})}let Qe="label";function Xe(e,r){let o=K(),{id:n=`headlessui-listbox-label-${o}`,...a}=e,t=B("Listbox.Label"),u=U("Listbox.Label"),c=k(t.labelRef,r);V(()=>u.registerLabel(n),[n]);let i=b(()=>{var m;return(m=t.buttonRef.current)==null?void 0:m.focus({preventScroll:!0})}),T=h(()=>({open:t.listboxState===0,disabled:t.disabled}),[t]);return _({ourProps:{ref:c,id:n,onClick:i},theirProps:a,slot:T,defaultTag:Qe,name:"Listbox.Label"})}let $e="ul",ze=oe.RenderStrategy|oe.Static;function Je(e,r){var p;let o=K(),{id:n=`headlessui-listbox-options-${o}`,...a}=e,t=B("Listbox.Options"),u=U("Listbox.Options"),c=k(t.optionsRef,r),i=j(),T=j(),S=Ae(),m=(()=>S!==null?(S&W.Open)===W.Open:t.listboxState===0)();ee(()=>{var x;let l=t.optionsRef.current;l&&t.listboxState===0&&l!==((x=Fe(l))==null?void 0:x.activeElement)&&l.focus({preventScroll:!0})},[t.listboxState,t.optionsRef]);let P=b(l=>{switch(T.dispose(),l.key){case y.Space:if(t.searchQuery!=="")return l.preventDefault(),l.stopPropagation(),u.search(l.key);case y.Enter:if(l.preventDefault(),l.stopPropagation(),t.activeOptionIndex!==null){let{dataRef:x}=t.options[t.activeOptionIndex];u.onChange(x.current.value)}t.mode===0&&(u.closeListbox(),X().nextFrame(()=>{var x;return(x=t.buttonRef.current)==null?void 0:x.focus({preventScroll:!0})}));break;case C(t.orientation,{vertical:y.ArrowDown,horizontal:y.ArrowRight}):return l.preventDefault(),l.stopPropagation(),u.goToOption(R.Next);case C(t.orientation,{vertical:y.ArrowUp,horizontal:y.ArrowLeft}):return l.preventDefault(),l.stopPropagation(),u.goToOption(R.Previous);case y.Home:case y.PageUp:return l.preventDefault(),l.stopPropagation(),u.goToOption(R.First);case y.End:case y.PageDown:return l.preventDefault(),l.stopPropagation(),u.goToOption(R.Last);case y.Escape:return l.preventDefault(),l.stopPropagation(),u.closeListbox(),i.nextFrame(()=>{var x;return(x=t.buttonRef.current)==null?void 0:x.focus({preventScroll:!0})});case y.Tab:l.preventDefault(),l.stopPropagation();break;default:l.key.length===1&&(u.search(l.key),T.setTimeout(()=>u.clearSearch(),350));break}}),g=te(()=>{var l,x,E;return(E=(l=t.labelRef.current)==null?void 0:l.id)!=null?E:(x=t.buttonRef.current)==null?void 0:x.id},[t.labelRef.current,t.buttonRef.current]),v=h(()=>({open:t.listboxState===0}),[t]),A={"aria-activedescendant":t.activeOptionIndex===null||(p=t.options[t.activeOptionIndex])==null?void 0:p.id,"aria-multiselectable":t.mode===1?!0:void 0,"aria-labelledby":g,"aria-orientation":t.orientation,id:n,onKeyDown:P,role:"listbox",tabIndex:0,ref:c};return _({ourProps:A,theirProps:a,slot:v,defaultTag:$e,features:ze,visible:m,name:"Listbox.Options"})}let qe="li";function Ye(e,r){let o=K(),{id:n=`headlessui-listbox-option-${o}`,disabled:a=!1,value:t,...u}=e,c=B("Listbox.Option"),i=U("Listbox.Option"),T=c.activeOptionIndex!==null?c.options[c.activeOptionIndex].id===n:!1,S=c.isSelected(t),m=D(null),P=ke({disabled:a,value:t,domRef:m,get textValue(){var L,d;return(d=(L=m.current)==null?void 0:L.textContent)==null?void 0:d.toLowerCase()}}),g=k(r,m);V(()=>{if(c.listboxState!==0||!T||c.activationTrigger===0)return;let L=X();return L.requestAnimationFrame(()=>{var d,H;(H=(d=m.current)==null?void 0:d.scrollIntoView)==null||H.call(d,{block:"nearest"})}),L.dispose},[m,T,c.listboxState,c.activationTrigger,c.activeOptionIndex]),V(()=>i.registerOption(n,P),[P,n]);let v=b(L=>{if(a)return L.preventDefault();i.onChange(t),c.mode===0&&(i.closeListbox(),X().nextFrame(()=>{var d;return(d=c.buttonRef.current)==null?void 0:d.focus({preventScroll:!0})}))}),A=b(()=>{if(a)return i.goToOption(R.Nothing);i.goToOption(R.Specific,n)}),p=we(),l=b(L=>p.update(L)),x=b(L=>{p.wasMoved(L)&&(a||T||i.goToOption(R.Specific,n,0))}),E=b(L=>{p.wasMoved(L)&&(a||T&&i.goToOption(R.Nothing))}),Q=h(()=>({active:T,selected:S,disabled:a}),[T,S,a]);return _({ourProps:{id:n,ref:g,role:"option",tabIndex:a===!0?void 0:-1,"aria-disabled":a===!0?!0:void 0,"aria-selected":S,disabled:void 0,onClick:v,onFocus:A,onPointerEnter:l,onMouseEnter:l,onPointerMove:x,onMouseMove:x,onPointerLeave:E,onMouseLeave:E},theirProps:u,slot:Q,defaultTag:qe,name:"Listbox.Option"})}let Ze=w(Ke),et=w(We),tt=w(Xe),ot=w(Je),nt=w(Ye),Bt=Object.assign(Ze,{Button:et,Label:tt,Options:ot,Option:nt});export{Bt as Listbox};
