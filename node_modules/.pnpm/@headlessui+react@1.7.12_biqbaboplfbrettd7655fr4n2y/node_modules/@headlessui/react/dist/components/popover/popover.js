import M,{createContext as X,createRef as ue,useContext as Y,useEffect as q,useMemo as D,useReducer as me,useRef as V,useState as ie}from"react";import{match as k}from'../../utils/match.js';import{forwardRefWithAs as $,render as J,Features as z}from'../../utils/render.js';import{optionalRef as ye,useSyncRefs as U}from'../../hooks/use-sync-refs.js';import{useId as K}from'../../hooks/use-id.js';import{Keys as _}from'../keyboard.js';import{isDisabledReactIssue7711 as fe}from'../../utils/bugs.js';import{getFocusableElements as Z,Focus as h,focusIn as w,isFocusableElement as Ee,FocusableMode as ge,FocusResult as ee}from'../../utils/focus-management.js';import{OpenClosedProvider as be,State as W,useOpenClosed as Pe}from'../../internal/open-closed.js';import{useResolveButtonType as Se}from'../../hooks/use-resolve-button-type.js';import{useOutsideClick as Ae}from'../../hooks/use-outside-click.js';import{getOwnerDocument as Re}from'../../utils/owner.js';import{useOwnerDocument as te}from'../../hooks/use-owner.js';import{useEventListener as Oe}from'../../hooks/use-event-listener.js';import{Hidden as oe,Features as re}from'../../internal/hidden.js';import{useEvent as b}from'../../hooks/use-event.js';import{useTabDirection as ce,Direction as H}from'../../hooks/use-tab-direction.js';import'../../utils/micro-task.js';import{useLatestValue as de}from'../../hooks/use-latest-value.js';import{useIsoMorphicEffect as Ce}from'../../hooks/use-iso-morphic-effect.js';var Fe=(s=>(s[s.Open=0]="Open",s[s.Closed=1]="Closed",s))(Fe||{}),Ie=(t=>(t[t.TogglePopover=0]="TogglePopover",t[t.ClosePopover=1]="ClosePopover",t[t.SetButton=2]="SetButton",t[t.SetButtonId=3]="SetButtonId",t[t.SetPanel=4]="SetPanel",t[t.SetPanelId=5]="SetPanelId",t))(Ie||{});let xe={[0]:o=>({...o,popoverState:k(o.popoverState,{[0]:1,[1]:0})}),[1](o){return o.popoverState===1?o:{...o,popoverState:1}},[2](o,l){return o.button===l.button?o:{...o,button:l.button}},[3](o,l){return o.buttonId===l.buttonId?o:{...o,buttonId:l.buttonId}},[4](o,l){return o.panel===l.panel?o:{...o,panel:l.panel}},[5](o,l){return o.panelId===l.panelId?o:{...o,panelId:l.panelId}}},ne=X(null);ne.displayName="PopoverContext";function Q(o){let l=Y(ne);if(l===null){let s=new Error(`<${o} /> is missing a parent <Popover /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(s,Q),s}return l}let le=X(null);le.displayName="PopoverAPIContext";function ae(o){let l=Y(le);if(l===null){let s=new Error(`<${o} /> is missing a parent <Popover /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(s,ae),s}return l}let pe=X(null);pe.displayName="PopoverGroupContext";function ve(){return Y(pe)}let se=X(null);se.displayName="PopoverPanelContext";function Le(){return Y(se)}function Me(o,l){return k(l.type,xe,o,l)}let Be="div";function De(o,l){var B;let s=V(null),R=U(l,ye(e=>{s.current=e})),C=V([]),r=me(Me,{popoverState:1,buttons:C,button:null,buttonId:null,panel:null,panelId:null,beforePanelSentinel:ue(),afterPanelSentinel:ue()}),[{popoverState:t,button:a,buttonId:v,panel:f,panelId:F,beforePanelSentinel:T,afterPanelSentinel:P},i]=r,p=te((B=s.current)!=null?B:a),c=D(()=>{if(!a||!f)return!1;for(let N of document.querySelectorAll("body > *"))if(Number(N==null?void 0:N.contains(a))^Number(N==null?void 0:N.contains(f)))return!0;let e=Z(),n=e.indexOf(a),A=(n+e.length-1)%e.length,g=(n+1)%e.length,G=e[A],Te=e[g];return!f.contains(G)&&!f.contains(Te)},[a,f]),S=de(v),y=de(F),I=D(()=>({buttonId:S,panelId:y,close:()=>i({type:1})}),[S,y,i]),O=ve(),x=O==null?void 0:O.registerPopover,j=b(()=>{var e;return(e=O==null?void 0:O.isFocusWithinPopoverGroup())!=null?e:(p==null?void 0:p.activeElement)&&((a==null?void 0:a.contains(p.activeElement))||(f==null?void 0:f.contains(p.activeElement)))});q(()=>x==null?void 0:x(I),[x,I]),Oe(p==null?void 0:p.defaultView,"focus",e=>{var n,A,g,G;t===0&&(j()||a&&f&&e.target!==window&&((A=(n=T.current)==null?void 0:n.contains)!=null&&A.call(n,e.target)||(G=(g=P.current)==null?void 0:g.contains)!=null&&G.call(g,e.target)||i({type:1})))},!0),Ae([a,f],(e,n)=>{i({type:1}),Ee(n,ge.Loose)||(e.preventDefault(),a==null||a.focus())},t===0);let L=b(e=>{i({type:1});let n=(()=>e?e instanceof HTMLElement?e:"current"in e&&e.current instanceof HTMLElement?e.current:a:a)();n==null||n.focus()}),u=D(()=>({close:L,isPortalled:c}),[L,c]),m=D(()=>({open:t===0,close:L}),[t,L]),E=o,d={ref:R};return M.createElement(ne.Provider,{value:r},M.createElement(le.Provider,{value:u},M.createElement(be,{value:k(t,{[0]:W.Open,[1]:W.Closed})},J({ourProps:d,theirProps:E,slot:m,defaultTag:Be,name:"Popover"}))))}let he="button";function He(o,l){let s=K(),{id:R=`headlessui-popover-button-${s}`,...C}=o,[r,t]=Q("Popover.Button"),{isPortalled:a}=ae("Popover.Button"),v=V(null),f=`headlessui-focus-sentinel-${K()}`,F=ve(),T=F==null?void 0:F.closeOthers,P=Le(),i=P===null?!1:P===r.panelId;q(()=>{if(!i)return t({type:3,buttonId:R}),()=>{t({type:3,buttonId:null})}},[i,R,t]);let[p]=ie(()=>Symbol()),c=U(v,l,i?null:e=>{if(e)r.buttons.current.push(p);else{let n=r.buttons.current.indexOf(p);n!==-1&&r.buttons.current.splice(n,1)}r.buttons.current.length>1&&console.warn("You are already using a <Popover.Button /> but only 1 <Popover.Button /> is supported."),e&&t({type:2,button:e})}),S=U(v,l),y=te(v),I=b(e=>{var n,A,g;if(i){if(r.popoverState===1)return;switch(e.key){case _.Space:case _.Enter:e.preventDefault(),(A=(n=e.target).click)==null||A.call(n),t({type:1}),(g=r.button)==null||g.focus();break}}else switch(e.key){case _.Space:case _.Enter:e.preventDefault(),e.stopPropagation(),r.popoverState===1&&(T==null||T(r.buttonId)),t({type:0});break;case _.Escape:if(r.popoverState!==0)return T==null?void 0:T(r.buttonId);if(!v.current||y!=null&&y.activeElement&&!v.current.contains(y.activeElement))return;e.preventDefault(),e.stopPropagation(),t({type:1});break}}),O=b(e=>{i||e.key===_.Space&&e.preventDefault()}),x=b(e=>{var n,A;fe(e.currentTarget)||o.disabled||(i?(t({type:1}),(n=r.button)==null||n.focus()):(e.preventDefault(),e.stopPropagation(),r.popoverState===1&&(T==null||T(r.buttonId)),t({type:0}),(A=r.button)==null||A.focus()))}),j=b(e=>{e.preventDefault(),e.stopPropagation()}),L=r.popoverState===0,u=D(()=>({open:L}),[L]),m=Se(o,v),E=i?{ref:S,type:m,onKeyDown:I,onClick:x}:{ref:c,id:r.buttonId,type:m,"aria-expanded":o.disabled?void 0:r.popoverState===0,"aria-controls":r.panel?r.panelId:void 0,onKeyDown:I,onKeyUp:O,onClick:x,onMouseDown:j},d=ce(),B=b(()=>{let e=r.panel;if(!e)return;function n(){k(d.current,{[H.Forwards]:()=>w(e,h.First),[H.Backwards]:()=>w(e,h.Last)})===ee.Error&&w(Z().filter(g=>g.dataset.headlessuiFocusGuard!=="true"),k(d.current,{[H.Forwards]:h.Next,[H.Backwards]:h.Previous}),{relativeTo:r.button})}n()});return M.createElement(M.Fragment,null,J({ourProps:E,theirProps:C,slot:u,defaultTag:he,name:"Popover.Button"}),L&&!i&&a&&M.createElement(oe,{id:f,features:re.Focusable,"data-headlessui-focus-guard":!0,as:"button",type:"button",onFocus:B}))}let Ge="div",ke=z.RenderStrategy|z.Static;function _e(o,l){let s=K(),{id:R=`headlessui-popover-overlay-${s}`,...C}=o,[{popoverState:r},t]=Q("Popover.Overlay"),a=U(l),v=Pe(),f=(()=>v!==null?(v&W.Open)===W.Open:r===0)(),F=b(i=>{if(fe(i.currentTarget))return i.preventDefault();t({type:1})}),T=D(()=>({open:r===0}),[r]);return J({ourProps:{ref:a,id:R,"aria-hidden":!0,onClick:F},theirProps:C,slot:T,defaultTag:Ge,features:ke,visible:f,name:"Popover.Overlay"})}let we="div",Ne=z.RenderStrategy|z.Static;function Ue(o,l){let s=K(),{id:R=`headlessui-popover-panel-${s}`,focus:C=!1,...r}=o,[t,a]=Q("Popover.Panel"),{close:v,isPortalled:f}=ae("Popover.Panel"),F=`headlessui-focus-sentinel-before-${K()}`,T=`headlessui-focus-sentinel-after-${K()}`,P=V(null),i=U(P,l,u=>{a({type:4,panel:u})}),p=te(P);Ce(()=>(a({type:5,panelId:R}),()=>{a({type:5,panelId:null})}),[R,a]);let c=Pe(),S=(()=>c!==null?(c&W.Open)===W.Open:t.popoverState===0)(),y=b(u=>{var m;switch(u.key){case _.Escape:if(t.popoverState!==0||!P.current||p!=null&&p.activeElement&&!P.current.contains(p.activeElement))return;u.preventDefault(),u.stopPropagation(),a({type:1}),(m=t.button)==null||m.focus();break}});q(()=>{var u;o.static||t.popoverState===1&&((u=o.unmount)==null||u)&&a({type:4,panel:null})},[t.popoverState,o.unmount,o.static,a]),q(()=>{if(!C||t.popoverState!==0||!P.current)return;let u=p==null?void 0:p.activeElement;P.current.contains(u)||w(P.current,h.First)},[C,P,t.popoverState]);let I=D(()=>({open:t.popoverState===0,close:v}),[t,v]),O={ref:i,id:R,onKeyDown:y,onBlur:C&&t.popoverState===0?u=>{var E,d,B,e,n;let m=u.relatedTarget;m&&P.current&&((E=P.current)!=null&&E.contains(m)||(a({type:1}),((B=(d=t.beforePanelSentinel.current)==null?void 0:d.contains)!=null&&B.call(d,m)||(n=(e=t.afterPanelSentinel.current)==null?void 0:e.contains)!=null&&n.call(e,m))&&m.focus({preventScroll:!0})))}:void 0,tabIndex:-1},x=ce(),j=b(()=>{let u=P.current;if(!u)return;function m(){k(x.current,{[H.Forwards]:()=>{var d;w(u,h.First)===ee.Error&&((d=t.afterPanelSentinel.current)==null||d.focus())},[H.Backwards]:()=>{var E;(E=t.button)==null||E.focus({preventScroll:!0})}})}m()}),L=b(()=>{let u=P.current;if(!u)return;function m(){k(x.current,{[H.Forwards]:()=>{var A;if(!t.button)return;let E=Z(),d=E.indexOf(t.button),B=E.slice(0,d+1),n=[...E.slice(d+1),...B];for(let g of n.slice())if(g.dataset.headlessuiFocusGuard==="true"||(A=t.panel)!=null&&A.contains(g)){let G=n.indexOf(g);G!==-1&&n.splice(G,1)}w(n,h.First,{sorted:!1})},[H.Backwards]:()=>{var d;w(u,h.Previous)===ee.Error&&((d=t.button)==null||d.focus())}})}m()});return M.createElement(se.Provider,{value:R},S&&f&&M.createElement(oe,{id:F,ref:t.beforePanelSentinel,features:re.Focusable,"data-headlessui-focus-guard":!0,as:"button",type:"button",onFocus:j}),J({ourProps:O,theirProps:r,slot:I,defaultTag:we,features:Ne,visible:S,name:"Popover.Panel"}),S&&f&&M.createElement(oe,{id:T,ref:t.afterPanelSentinel,features:re.Focusable,"data-headlessui-focus-guard":!0,as:"button",type:"button",onFocus:L}))}let Ke="div";function We(o,l){let s=V(null),R=U(s,l),[C,r]=ie([]),t=b(p=>{r(c=>{let S=c.indexOf(p);if(S!==-1){let y=c.slice();return y.splice(S,1),y}return c})}),a=b(p=>(r(c=>[...c,p]),()=>t(p))),v=b(()=>{var S;let p=Re(s);if(!p)return!1;let c=p.activeElement;return(S=s.current)!=null&&S.contains(c)?!0:C.some(y=>{var I,O;return((I=p.getElementById(y.buttonId.current))==null?void 0:I.contains(c))||((O=p.getElementById(y.panelId.current))==null?void 0:O.contains(c))})}),f=b(p=>{for(let c of C)c.buttonId.current!==p&&c.close()}),F=D(()=>({registerPopover:a,unregisterPopover:t,isFocusWithinPopoverGroup:v,closeOthers:f}),[a,t,v,f]),T=D(()=>({}),[]),P=o,i={ref:R};return M.createElement(pe.Provider,{value:F},J({ourProps:i,theirProps:P,slot:T,defaultTag:Ke,name:"Popover.Group"}))}let je=$(De),Ve=$(He),$e=$(_e),Je=$(Ue),Xe=$(We),Lt=Object.assign(je,{Button:Ve,Overlay:$e,Panel:Je,Group:Xe});export{Lt as Popover};
