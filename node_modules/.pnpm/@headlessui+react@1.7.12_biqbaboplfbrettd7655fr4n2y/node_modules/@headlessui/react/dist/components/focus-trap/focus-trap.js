import d,{useEffect as B,useRef as p}from"react";import{forwardRefWithAs as C,render as U}from'../../utils/render.js';import{useServerHandoffComplete as x}from'../../hooks/use-server-handoff-complete.js';import{useSyncRefs as N}from'../../hooks/use-sync-refs.js';import{Features as R,Hidden as g}from'../../internal/hidden.js';import{focusElement as c,focusIn as b,Focus as m,FocusResult as I}from'../../utils/focus-management.js';import{match as v}from'../../utils/match.js';import{useEvent as G}from'../../hooks/use-event.js';import{useTabDirection as K,Direction as M}from'../../hooks/use-tab-direction.js';import{useIsMounted as y}from'../../hooks/use-is-mounted.js';import{useOwnerDocument as V}from'../../hooks/use-owner.js';import{useEventListener as O}from'../../hooks/use-event-listener.js';import{microTask as A}from'../../utils/micro-task.js';import{useWatch as k}from'../../hooks/use-watch.js';import{useDisposables as W}from'../../hooks/use-disposables.js';let q="div";var P=(t=>(t[t.None=1]="None",t[t.InitialFocus=2]="InitialFocus",t[t.TabLock=4]="TabLock",t[t.FocusLock=8]="FocusLock",t[t.RestoreFocus=16]="RestoreFocus",t[t.All=30]="All",t))(P||{});function J(r,l){let e=p(null),n=N(e,l),{initialFocus:u,containers:o,features:t=30,...a}=r;x()||(t=1);let T=V(e);z({ownerDocument:T},Boolean(t&16));let f=Q({ownerDocument:T,container:e,initialFocus:u},Boolean(t&2));Y({ownerDocument:T,container:e,containers:o,previousActiveElement:f},Boolean(t&8));let F=K(),H=G(s=>{let i=e.current;if(!i)return;(_=>_())(()=>{v(F.current,{[M.Forwards]:()=>{b(i,m.First,{skipElements:[s.relatedTarget]})},[M.Backwards]:()=>{b(i,m.Last,{skipElements:[s.relatedTarget]})}})})}),S=W(),L=p(!1),h={ref:n,onKeyDown(s){s.key=="Tab"&&(L.current=!0,S.requestAnimationFrame(()=>{L.current=!1}))},onBlur(s){let i=new Set(o==null?void 0:o.current);i.add(e);let E=s.relatedTarget;E instanceof HTMLElement&&E.dataset.headlessuiFocusGuard!=="true"&&(j(i,E)||(L.current?b(e.current,v(F.current,{[M.Forwards]:()=>m.Next,[M.Backwards]:()=>m.Previous})|m.WrapAround,{relativeTo:s.target}):s.target instanceof HTMLElement&&c(s.target)))}};return d.createElement(d.Fragment,null,Boolean(t&4)&&d.createElement(g,{as:"button",type:"button","data-headlessui-focus-guard":!0,onFocus:H,features:R.Focusable}),U({ourProps:h,theirProps:a,defaultTag:q,name:"FocusTrap"}),Boolean(t&4)&&d.createElement(g,{as:"button",type:"button","data-headlessui-focus-guard":!0,onFocus:H,features:R.Focusable}))}let X=C(J),Le=Object.assign(X,{features:P});function z({ownerDocument:r},l){let e=p(null);O(r==null?void 0:r.defaultView,"focusout",u=>{l&&(e.current||(e.current=u.target))},!0),k(()=>{l||((r==null?void 0:r.activeElement)===(r==null?void 0:r.body)&&c(e.current),e.current=null)},[l]);let n=p(!1);B(()=>(n.current=!1,()=>{n.current=!0,A(()=>{n.current&&(c(e.current),e.current=null)})}),[])}function Q({ownerDocument:r,container:l,initialFocus:e},n){let u=p(null),o=y();return k(()=>{if(!n)return;let t=l.current;t&&A(()=>{if(!o.current)return;let a=r==null?void 0:r.activeElement;if(e!=null&&e.current){if((e==null?void 0:e.current)===a){u.current=a;return}}else if(t.contains(a)){u.current=a;return}e!=null&&e.current?c(e.current):b(t,m.First)===I.Error&&console.warn("There are no focusable elements inside the <FocusTrap />"),u.current=r==null?void 0:r.activeElement})},[n]),u}function Y({ownerDocument:r,container:l,containers:e,previousActiveElement:n},u){let o=y();O(r==null?void 0:r.defaultView,"focus",t=>{if(!u||!o.current)return;let a=new Set(e==null?void 0:e.current);a.add(l);let T=n.current;if(!T)return;let f=t.target;f&&f instanceof HTMLElement?j(a,f)?(n.current=f,c(f)):(t.preventDefault(),t.stopPropagation(),c(T)):c(n.current)},!0)}function j(r,l){var e;for(let n of r)if((e=n.current)!=null&&e.contains(l))return!0;return!1}export{Le as FocusTrap};
